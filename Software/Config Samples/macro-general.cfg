####################################################################################
#	                         TESTING
####################################################################################
#--------------------------------------------------------------------
[gcode_macro DUMP_VARIABLES]
gcode:
    {% set filter_name = params.NAME|default('')|string|lower %}
    {% set filter_value = params.VALUE|default('')|string|lower %}
    {% set show_cfg = params.SHOW_CFG|default(0)|int %}

    {% set out = [] %}

    {% for key1 in printer %}
        {% for key2 in printer[key1] %}
            {% if (show_cfg or not (key1|lower == 'configfile' and key2|lower in ['config', 'settings'])) and (filter_name in key1|lower or filter_name in key2|lower) and filter_value in printer[key1][key2]|string|lower %}
                {% set dummy = out.append("printer['%s'].%s = %s" % (key1, key2, printer[key1][key2])) %}
            {% endif %}
        {% else %}
            {% if filter_name in key1|lower and filter_value in printer[key1]|string|lower %}
                {% set dummy = out.append("printer['%s'] = %s" % (key1, printer[key1])) %}
            {% endif %}
        {% endfor %}
    {% endfor %}

    {action_respond_info(out|join("\n"))}

#--------------------------------------------------------------------
[gcode_macro TEST_TC_20]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                                 # Homing all axes
        QUAD_GANTRY_LEVEL
    {% endif %}
    G1 Z50 F1500
    {% for n in range(20) %}
      T{ printer.toolchanger.tool_numbers | random }
    {% endfor %}

#--------------------------------------------------------------------
[gcode_macro TEST_TC_2500]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                                 # Homing all axes
        QUAD_GANTRY_LEVEL
    {% endif %}
    G1 Z50 F1500
    {% for n in range(2500) %}
      T{ printer.toolchanger.tool_numbers | random }
    {% endfor %}

#--------------------------------------------------------------------
[gcode_macro TEST_Dock]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                                 # Homing all axes
    {% endif %}
    TEST_TOOL_DOCKING

#--------------------------------------------------------------------
[gcode_macro TEST_Dock_1250]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                                 # Homing all axes
        QUAD_GANTRY_LEVEL
    {% endif %}
    G1 Z50 F1500
    {% for n in range(1250) %}
        RESPOND TYPE=echo MSG='Tool change no: {n}'
        TEST_TOOL_DOCKING
    {% endfor %}

#--------------------------------------------------------------------
[gcode_macro TEST]
gcode:
    {% set tools = printer.toolchanger.tool_numbers %}
    {% for tool in tools|reverse %}
        T{tool}
    {% endfor %}
    
####################################################################################
#	                         Operation Macros
####################################################################################
#--------------------------------------------------------------------
[gcode_macro QUAD_GANTRY_LEVEL]
description: initialse toolhead before QGL
rename_existing: _QUAD_GANTRY_LEVEL
gcode:
    INITIALIZE_TOOLCHANGER
    _QUAD_GANTRY_LEVEL

#--------------------------------------------------------------------
[gcode_macro PRINT_STATUS]
gcode:
    {% set obj = params.OBJ %}
    RESPOND TYPE=echo MSG="Status for M190 {obj} is { printer[obj] }"

#--------------------------------------------------------------------
[gcode_macro PRESENT_TOOLHEAD]
gcode:
    ### Check if axes are homed ###
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                    # Homing all axes
    {% endif %}
    G0 X175 Y175 Z250 F9000    # Place toolhead centre-front-250mm

#--------------------------------------------------------------------
[gcode_macro UNLOAD_FILAMENT]
gcode:
    M117 Unloading
    M104 S240                     ; Heat up the filament
    TEMPERATURE_WAIT SENSOR={printer.toolhead.extruder} MINIMUM=240
    M83                           ; set extruder to relative
    G1 E5 F500                    ; extrude 5 mm
    G1 E-50 F1000                 ; retract 5 cm
    G1 E-30 F1000                 ; retract 5 cm
    M82                           ; set extruder to absolute
    M400                          ; wait for buffer to clear
    TURN_OFF_HEATERS
    M117 Unloading done

[gcode_macro FIL_UNLOAD]
gcode:
    UNLOAD_FILAMENT
    
#--------------------------------------------------------------------
[gcode_macro LOAD_FILAMENT]
gcode:
    M117 Loading
    M104 S240
    TEMPERATURE_WAIT SENSOR={printer.toolhead.extruder} MINIMUM=240
    M83                           ; set extruder to relative
    G1 E50 F300                   ; extrude 5 cm
    G1 E30 F300                   ; extrude 5 cm
    G1 E-10 F1800                 ; retract some
    M82                           ; set extruder to absolute
    M400                          ; wait for buffer to clear
    M104 S0                       ; Stop heating
    M117 Loading done

[gcode_macro FIL_LOAD]
gcode:
    LOAD_FILAMENT
    
#--------------------------------------------------------------------
[gcode_macro PROBE_CALIBRATION]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                       # Homing all axes
    {% endif %}
    G0 X175 Y175 Z1 F3600         # Centre the toolhead
    PROBE_CALIBRATE

#--------------------------------------------------------------------
[gcode_macro HEAT_SOAK_40]
gcode:
    RESPOND TYPE=echo MSG='{"Chamber Heat Soak..."}'
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=100
    TEMPERATURE_WAIT SENSOR="temperature_sensor Chamber" MINIMUM=40

#--------------------------------------------------------------------
[gcode_macro DAYBREAK]
gcode:
    {% if printer['output_pin daylight'].value == 0.0 %}
        SET_PIN PIN=daylight VALUE=0.50
    {% else %}
        SET_PIN PIN=daylight VALUE=0.00
    {% endif %}
